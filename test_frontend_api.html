<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æµ‹è¯• - èƒ¶å›Šåˆ†ç±»</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
        }
        .error {
            border-left-color: #dc3545;
        }
        pre {
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .login-form {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .login-form input {
            padding: 8px;
            margin: 5px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª API æµ‹è¯• - èƒ¶å›Šåˆ†ç±»åŠŸèƒ½</h1>

        <div class="login-form">
            <h3>ç™»å½•</h3>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="testuser">
            <input type="password" id="password" placeholder="å¯†ç " value="testpass">
            <button onclick="login()">ç™»å½•</button>
            <p id="loginStatus">æœªç™»å½•</p>
        </div>

        <div>
            <button onclick="fetchCapsules()" id="fetchBtn" disabled>è·å–èƒ¶å›Šåˆ—è¡¨</button>
            <button onclick="fetchCategories()" id="fetchCategoriesBtn" disabled>è·å–åˆ†ç±»åˆ—è¡¨</button>
            <button onclick="testCategoryUpdate()" id="updateBtn" disabled>æµ‹è¯•æ›´æ–°åˆ†ç±»</button>
        </div>

        <div class="result" id="result">
            <p>ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let token = localStorage.getItem('token') || null;

        function updateResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result ' + type;
            resultDiv.innerHTML = `<pre>${message}</pre>`;
        }

        function enableButtons() {
            document.getElementById('fetchBtn').disabled = false;
            document.getElementById('fetchCategoriesBtn').disabled = false;
            document.getElementById('updateBtn').disabled = false;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    document.getElementById('loginStatus').textContent = 'âœ“ å·²ç™»å½•';
                    document.getElementById('loginStatus').style.color = 'green';
                    enableButtons();
                    updateResult('ç™»å½•æˆåŠŸï¼\n' + JSON.stringify(data, null, 2), 'success');
                } else {
                    updateResult('ç™»å½•å¤±è´¥ï¼š\n' + JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                updateResult('ç™»å½•é”™è¯¯ï¼š\n' + error.message, 'error');
            }
        }

        async function fetchCapsules() {
            try {
                const response = await fetch(`${API_URL}/api/capsules`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const capsulesWithDetails = data.map(c => ({
                        id: c.id,
                        title: c.title,
                        category_id: c.category_id,
                        category_id_type: typeof c.category_id
                    }));

                    updateResult('è·å–èƒ¶å›Šåˆ—è¡¨æˆåŠŸï¼\n' + JSON.stringify(capsulesWithDetails, null, 2), 'success');
                    return data;
                } else {
                    updateResult('è·å–èƒ¶å›Šåˆ—è¡¨å¤±è´¥ï¼š\n' + JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                updateResult('è·å–èƒ¶å›Šåˆ—è¡¨é”™è¯¯ï¼š\n' + error.message, 'error');
            }
        }

        async function fetchCategories() {
            try {
                const response = await fetch(`${API_URL}/api/categories`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    updateResult('è·å–åˆ†ç±»åˆ—è¡¨æˆåŠŸï¼\n' + JSON.stringify(data, null, 2), 'success');
                    return data;
                } else {
                    updateResult('è·å–åˆ†ç±»åˆ—è¡¨å¤±è´¥ï¼š\n' + JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                updateResult('è·å–åˆ†ç±»åˆ—è¡¨é”™è¯¯ï¼š\n' + error.message, 'error');
            }
        }

        async function testCategoryUpdate() {
            // æ­¥éª¤ 1: è·å–ç¬¬ä¸€ä¸ªèƒ¶å›Š
            const capsules = await fetchCapsules();
            if (!capsules || capsules.length === 0) {
                updateResult('æ²¡æœ‰æ‰¾åˆ°èƒ¶å›Š', 'error');
                return;
            }

            const capsule = capsules[0];
            updateResult(`æ­¥éª¤ 1: æ‰¾åˆ°èƒ¶å›Š ID ${capsule.id}\nå½“å‰åˆ†ç±» ID: ${capsule.category_id} (type: ${typeof capsule.category_id})\næ ‡é¢˜: ${capsule.title}`);

            // æ­¥éª¤ 2: è·å–åˆ†ç±»åˆ—è¡¨
            const categories = await fetchCategories();
            if (!categories || categories.length === 0) {
                updateResult('æ²¡æœ‰æ‰¾åˆ°åˆ†ç±»', 'error');
                return;
            }

            // é€‰æ‹©ä¸€ä¸ªä¸åŒçš„åˆ†ç±»
            let newCategory = null;
            for (const cat of categories) {
                if (cat.id !== capsule.category_id) {
                    newCategory = cat;
                    break;
                }
            }

            if (!newCategory) {
                updateResult('æ²¡æœ‰å¯ç”¨çš„ä¸åŒåˆ†ç±»', 'error');
                return;
            }

            updateResult(`æ­¥éª¤ 2: é€‰æ‹©æ–°åˆ†ç±»\nåˆ†ç±» ID: ${newCategory.id}\nåˆ†ç±»åç§°: ${newCategory.name}`);

            // æ­¥éª¤ 3: æ›´æ–°èƒ¶å›Š
            try {
                const updateData = {
                    title: capsule.title,
                    content: capsule.content,
                    mood: capsule.mood,
                    tags: capsule.tags ? JSON.parse(capsule.tags) : [],
                    open_date: capsule.open_date,
                    image_path: capsule.image_path || '',
                    category_id: newCategory.id
                };

                const response = await fetch(`${API_URL}/api/capsules/${capsule.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (response.ok) {
                    updateResult(`æ­¥éª¤ 3: æ›´æ–°æˆåŠŸï¼\n\næ›´æ–°æ•°æ®:\n${JSON.stringify(updateData, null, 2)}\n\nå“åº”:\n${JSON.stringify(result, null, 2)}`, 'success');

                    // æ­¥éª¤ 4: éªŒè¯æ›´æ–°
                    setTimeout(async () => {
                        const updatedCapsules = await fetchCapsules();
                        const updatedCapsule = updatedCapsules.find(c => c.id === capsule.id);

                        if (updatedCapsule) {
                            if (updatedCapsule.category_id === newCategory.id) {
                                updateResult(`âœ… æµ‹è¯•é€šè¿‡ï¼\n\nèƒ¶å›Š ID: ${updatedCapsule.id}\næ–°åˆ†ç±» ID: ${updatedCapsule.category_id} (type: ${typeof updatedCapsule.category_id})\næœŸæœ›åˆ†ç±» ID: ${newCategory.id}\n\nåˆ†ç±»å·²æ­£ç¡®æ›´æ–°ï¼`, 'success');
                            } else {
                                updateResult(`âŒ æµ‹è¯•å¤±è´¥ï¼\n\nèƒ¶å›Š ID: ${updatedCapsule.id}\nå®é™…åˆ†ç±» ID: ${updatedCapsule.category_id}\næœŸæœ›åˆ†ç±» ID: ${newCategory.id}`, 'error');
                            }
                        }
                    }, 500);
                } else {
                    updateResult('æ›´æ–°å¤±è´¥ï¼š\n' + JSON.stringify(result, null, 2), 'error');
                }
            } catch (error) {
                updateResult('æ›´æ–°é”™è¯¯ï¼š\n' + error.message, 'error');
            }
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (token) {
            document.getElementById('loginStatus').textContent = 'âœ“ å·²ç™»å½•';
            document.getElementById('loginStatus').style.color = 'green';
            enableButtons();
        }
    </script>
</body>
</html>